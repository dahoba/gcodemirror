	private static final String HEIGHT = "height";
	private static final String WIDTH = "width";
	public static final String IFRAME_CLASS = "iframeClass";

	private Element place;
	private Map<String, Object> options;

	private IFrameElement frame;
	private DivElement wrapper;
	private TextAreaElement textarea;

	public CodeMirror(String id, Map<String, Object> options)
	{
		this(Document.get().getElementById(id), options);
	}

	public CodeMirror(Element place, Map<String, Object> options)
	{
		this.place = place;
		this.options = options;
		// TODO: Set defaults

		initialize();
	}

	private void initialize()
	{
		frame = Document.get().createIFrameElement();

		String clsname = (String) options.get(IFRAME_CLASS);
		if(clsname != null && clsname.length() > 0)
		{
			frame.setClassName(clsname);
		}
		
		frame.setFrameBorder(0);
		frame.setSrc("javascript:;");
		Style style = frame.getStyle();
		style.setBorderWidth(0, Unit.PX);
		style.setWidth(100, Unit.PCT);
		style.setHeight(100, Unit.PCT);
		style.setDisplay(Display.BLOCK);

		wrapper = Document.get().createDivElement();
		wrapper.setClassName("CodeMirror-wrapping");
		style = wrapper.getStyle();
		style.setPosition(Position.RELATIVE);

		Object obj;

		obj = options.get(WIDTH);
		if(obj != null && obj instanceof String)
		{
			style.setProperty(WIDTH, (String) obj);
		}

		//TODO: "Dynamic Height" support
		obj = options.get(HEIGHT);
		if(obj != null && obj instanceof String)
		{
			style.setProperty(HEIGHT, (String) obj);
		}

		textarea = Document.get().createTextAreaElement();
		style = textarea.getStyle();
		style.setPosition(Position.ABSOLUTE);
		style.setLeft(-10000, Unit.PX);
		style.setWidth(10, Unit.PX);

		place.appendChild(wrapper);

		wrapper.appendChild(textarea);
		wrapper.appendChild(frame);
		//frame.setInnerHTML("<html><head></head><body>Body</body></html>");

		writeFrameContent(frame, "Write code");
	}

	public void setHTML(String html)
	{
		writeFrameContent(frame, html);
	}

	private native void writeFrameContent(IFrameElement frame, String html) /*-{
		var win = frame.contentWindow;
		win.document.open();
		win.document.write("<html><head></head><body>" + html + "</body></html>");
		win.document.close();
	}-*/;
